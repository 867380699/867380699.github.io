---
layout: nav
title: Search
---

<div class="index">
  <div id="search-container">
    <input
      type="text"
      id="search-input"
      autocomplete="off"
      placeholder="搜索..."
      autofocus
    />
    <ul id="results-container"></ul>
  </div>
</div>

<script>
let data;
const searchInput = document.getElementById("search-input");
const resultsContainer = document.getElementById("results-container");

async function init() {
  if (!data) {
    data = await fetchData();
  }
  searchInput.addEventListener("input", function (e) {
    if (isWhitelistedKey(e.which)) {
      jekyllSearch(e.target.value);
    }
  });
}
init();

function isWhitelistedKey(key) {
  return [13, 16, 20, 37, 38, 39, 40, 91].indexOf(key) === -1;
}

function fetchData() {
  return fetch("/search/search.json").then(function (response) {
    return response.json();
  });
}

function render(url, title, date, tags) {
  return `<li class="blog-item"><a href="${url}">${title}&nbsp;<span class="blog-date">${date}</span>&nbsp;<span class="search-tags">${tags}</span></a></li>`;
}
function renderMatchWord(word, match) {
  if (match) {
    return match
      .map((w) => (w.isMatch ? `<strong>${w.text}</strong>` : w.text))
      .join('');
  } else {
    return word;
  }
}
function jekyllSearch(query) {
  resultsContainer.innerHTML = "";
  const result = fuzzySearch(data, query, { keys: ["title", "tags"] });
  resultsContainer.innerHTML = result
    .map((r) =>
      render(
        r.data.url,
        renderMatchWord(r.data.title, r.result[0]),
        r.data.date,
        renderMatchWord(r.data.tags, r.result[1])
      )
    )
    .join('');
}

function fuzzySearch(objList, query, options) {
  if (!query || !objList.length) return [];
  const keys = options.keys || Object.keys(objList[0]);
  return []
    .concat(objList)
    .map((obj) => {
      const result = keys.map((k) => matchTerm(obj[k], query));
      return {
        data: obj,
        result: result.map((r) => r && r.result),
        score: result.reduce(
          (a, b, i) => a + ((b && b.score / (i + 1)) || 0),
          0
        ),
      };
    })
    .filter((m) => m.score)
    .sort((a, b) => a.score - b.score)
    .reverse();
}

function matchTerm(term, query) {
  if (!term) return;
  const termArray = term.toLowerCase().split(new RegExp(`([${query}])`));
  const queryArray = query.toLowerCase().split("");

  const result = [];
  let score = 0;
  let tmp_str = "";
  let matching = false;
  let matchCount = 0;

  function flushTemp() {
    if (tmp_str) {
      result.push({
        text: tmp_str,
        isMatch: matching,
      });
      if (matching) score += ((1 + tmp_str.length) * tmp_str.length) / 2;
      tmp_str = "";
    }
  }
  for (let i = 0, s; i < termArray.length; i++) {
    if ((s = termArray[i])) {
      if (matching != (s === queryArray[matchCount])) {
        flushTemp();
        matching = !matching;
      }
      tmp_str += s;
      if (matching) matchCount++;
    }
  }
  flushTemp();

  if (matchCount === queryArray.length) {
    return {
      score,
      result,
    };
  }
}
</script>
<script>
  var container = document.getElementById("search-container");

  var focusOrReset = function(ele) {
    if (ele) {
      ele.querySelector("a").focus();
    } else {
      document.querySelector("#search-input").focus();
    }
  };
  container.addEventListener("keydown", function(e) {
    if (e.code == "ArrowDown") {
      if (e.target.id === "search-input") {
        var li = document.querySelector("li.blog-item a");
        if (li) {
          e.target.blur();
          li.focus();
        }
      } else if (e.target.href && e.target.href.indexOf("/blog") >= 0) {
        var next = e.target.parentElement.nextElementSibling;
        focusOrReset(next);
      }
    } else if (e.code == "ArrowUp") {
      if (e.target.href && e.target.href.indexOf("/blog") >= 0) {
        var previous = e.target.parentElement.previousElementSibling;
        focusOrReset(previous);
      }
    }
  });
</script>
