---

layout: post
title: "GitLab"
date: 2021-07-02

---

使用 `Wiki` 方便实时更改

# CI

The pipeline starts when the commit is committed.

# Pipelines
Pipelines are the top-level component of CI/CD.

- Pipelines
  + Jobs - define **what** to do
  + Stages - define **when** to run the jobs

Jobs are executed by runners.

Multiple jobs in the same stage are executed in parallel, if there are enough concurrent runners.

A typical pipeline might consist of four stages:

- `build` *stage*
  + `compile` *job*
- `test` *stage*
  + `test1` *job*
  + `test2` *job*
- `staging` *stage*
  + `deploy-to-stage` *job*
- `production` *stage*
  + `deploy-to-prod` *job*


# Stages

default pipeline:

- `.pre`
- `build`
- `test`
- `deploy`
- `.post`

if a job dose not specify a stage, the job is assigned the `test` stage.

# Jobs

- `rules`
  - `if`
  - `only`
  - `except`

# workflow

Use `workflow` to control `pipeline` behavior.

# Variables

## Predefined

- `$CI_PIPELINE_SOURCE`
  + trigger

> <https://docs.gitlab.com/ee/ci/variables/predefined_variables.html>

# Cache

Use `cache` for dependencies, like packages you download from the internet. 

`Cache` is stored where GitLab `Runner` is installed.

- Define cache per `job` by using the `cache` keyword.
- Subsequent `pipelines` can use the cache.
- Subsequent `jobs` in the same pipeline can use the cache.


```yml
cache: &global_cache
  key: $CI_COMMIT_REF_SLUG
  paths:
    - node_modules/
    - public/
    - vendor/
  policy: pull-push

job:
  cache:
    # inherit all global cache settings
    <<: *global_cache
    # override the policy
    policy: pull
```

```yml
# jobs in each branch use the same cache
cache:
  key: $CI_COMMIT_REF_SLUG
```

```yml
# Compute the cache key from the lock file
cache:
  key:
    files:
      - package-lock.json
  paths:
    - .npm/
```


# Artifacts

Use `artifacts` to pass intermediate build results between `stages`. 

`Artifacts` are generated by a `job`, stored in GitLab, and can be downloaded.

# Misc

```js
Array.prototype.map.call(
    document.querySelectorAll('div.js-contrib-calendar rect.user-contrib-cell'),
    rect => +rect.getAttribute('title').split(' ')[0] || 0)
  .reduce((a, b) => a + b, 0)
```